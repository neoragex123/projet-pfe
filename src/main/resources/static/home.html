<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Tableau de bord - GTP</title>
    <style>
        body {
          font-family: 'Segoe UI', sans-serif;
          background: linear-gradient(to bottom right, #eef4fb, #d2e4ff);
          margin: 0;
          padding: 30px;
        }

        .container {
          max-width: 1000px;
          margin: auto;
          background: white;
          border-radius: 12px;
          padding: 30px;
          box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        h2, h3 {
          margin-top: 0;
          color: #003865;
        }

        .flex {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .section {
          margin-top: 25px;
          padding: 20px;
          background: #f9f9f9;
          border-radius: 8px;
        }

        .label {
          font-weight: bold;
        }

        button {
          margin: 6px 6px 12px 0;
          padding: 10px 20px;
          font-size: 14px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          background-color: #007bff;
          color: white;
        }

        button:hover {
          background-color: #0056b3;
        }

        button.stop {
          background-color: #dc3545;
        }

        button.stop:hover {
          background-color: #a71d2a;
        }

        .logout {
          text-decoration: none;
          font-weight: bold;
          color: #dc3545;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 15px;
        }

        th, td {
          border: 1px solid #ccc;
          padding: 8px 12px;
          text-align: center;
        }

        th {
          background: #003865;
          color: white;
        }

        .menu-block ul {
          list-style: none;
          padding: 0;
        }

        .menu-block li {
          margin-bottom: 8px;
        }

        .menu-block a {
          text-decoration: none;
          color: #003865;
          font-weight: bold;
        }

        .menu-block a:hover {
          text-decoration: underline;
        }

        .modal {
          display: none;
          position: fixed;
          z-index: 999;
          left: 0; top: 0;
          width: 100%; height: 100%;
          background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
          background-color: #fff;
          margin: 10% auto;
          padding: 20px;
          width: 400px;
          border-radius: 10px;
          position: relative;
          box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }

        .close {
          position: absolute;
          right: 15px;
          top: 10px;
          font-size: 22px;
          cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container">

    <div class="flex">
        <h2>Tableau de bord</h2>
        <a class="logout" href="/logout">Se dÃ©connecter</a>
    </div>

    <!-- Informations utilisateur -->
    <div class="section">
        <h3>ğŸ‘¤ Informations</h3>
        <p><span class="label">Nom :</span> <span id="nom">-</span></p>
        <p><span class="label">PrÃ©nom :</span> <span id="prenom">-</span></p>
        <p><span class="label">Email :</span> <span id="email">-</span></p>
        <p><span class="label">RÃ´le :</span> <span id="role">-</span></p>
        <p><span class="label">Solde de congÃ©s :</span> <span id="soldeConges">-</span> jours</p>
    </div>

    <!-- Pointage -->
    <div class="status-block">
        <h3>ğŸ“ Pointage de la journÃ©e</h3>
        <button onclick="pointerArrivee()">ğŸ•— Pointer lâ€™arrivÃ©e</button>
        <button onclick="pointerDepart()">ğŸšª Fin de journÃ©e</button>
        <p><strong>Date aujourdâ€™hui :</strong> <span id="date">-</span></p>
        <p><strong>Heure dâ€™arrivÃ©e :</strong> <span id="arrivee">-</span></p>
        <p><strong>Heure de dÃ©part :</strong> <span id="depart">-</span></p>
        <p><strong>Vous Ãªtes arrivÃ© depuis :</strong> <span id="dureeDepuisArrivee">-</span></p>
        <p><strong>Heure actuelle :</strong> <span id="heureActuelle">-</span></p>
    </div>
    <!-- Menu RH -->
    <div class="section menu-block" id="menu-rh" style="display: none;">
        <h3>ğŸ› Menu RH</h3>
        <ul>
            <li><a href="/ajout-user.html">ğŸ‘¤ Ajouter un utilisateur</a></li>
            <li><a href="/rh.html">ğŸ“‹ Gestion des congÃ©s</a></li>
        </ul>
    </div>

    <!-- Pause -->
    <div class="section">
        <h3>â¸ï¸ Pauses</h3>
        <button onclick="demarrerPause('CAFÃ‰')">â˜• Pause CafÃ©</button>
        <button onclick="demarrerPause('DÃ‰JEUNER')">ğŸ¥ª Pause DÃ©jeuner</button>
        <button onclick="demarrerPause('FORMATION')">ğŸ“š Pause Formation</button>
        <button class="stop" onclick="cloturerPause()">âœ… Fin de pause</button>
        <p><strong>DurÃ©e totale des pauses :</strong> <span id="dureePauses">-</span></p>
        <div id="status"></div>
    </div>

    <!-- Tableau des pauses -->
    <div class="section">
        <h3>ğŸ“… Historique des pauses</h3>
        <table>
            <thead>
            <tr>
                <th>Type</th>
                <th>Heure dÃ©but</th>
                <th>Heure fin</th>
                <th>DurÃ©e (min)</th>
            </tr>
            </thead>
            <tbody id="table-pauses"></tbody>
        </table>
    </div>
    <!-- Bouton pour demander un congÃ© -->
    <div style="text-align: center; margin-top: 30px;">
        <button onclick="openCongeModal()">ğŸ—“ Faire une demande de congÃ©</button>
    </div>

    <!-- Historique des congÃ©s -->
    <div class="section">
        <h3>ğŸ“‹ Mes demandes de congÃ©s</h3>
        <table>
            <thead>
            <tr><th>Type</th><th>Date dÃ©but</th><th>Date fin</th><th>Statut</th><th>Justificatif</th></tr>
            </thead>
            <tbody id="table-conges"></tbody>
        </table>
    </div>

</div> <!-- Fin de .container -->

<!-- Modal : Demande de congÃ© -->
<div id="congeModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeCongeModal()">&times;</span>
        <h3>Demande de congÃ©</h3>
        <form id="form-conge" enctype="multipart/form-data">
            <label>Type de congÃ© :</label><br>
            <select name="type" required>
                <option value="ANNUEL">Annuel</option>
                <option value="EXCEPTIONNEL">Exceptionnel</option>
                <option value="MALADIE">Maladie</option>
                <option value="DEMI_JOURNEE">Demi-journÃ©e</option>
            </select><br><br>

            <label>Date dÃ©but :</label><br>
            <input type="date" name="dateDebut" required><br><br>

            <label>Date fin :</label><br>
            <input type="date" name="dateFin" required><br><br>

            <label>Commentaire :</label><br>
            <textarea name="commentaire" rows="3" style="width: 100%;"></textarea><br><br>

            <label>Justificatif :</label><br>
            <input type="file" name="justificatif"><br><br>

            <button type="submit">ğŸ“¤ Envoyer</button>
            <p id="msg-conge" style="color: green;"></p>
        </form>
    </div>
</div>
<script>
    let arriveeTime = null;

    function formatTime(date) {
      return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function pointerArrivee() {
      fetch('/api/pointage/arrivee', { method: 'POST' })
        .then(res => {
          if (res.ok) {
            alert("âœ… ArrivÃ©e enregistrÃ©e !");
            loadPointage();
          } else {
            res.text().then(msg => alert("âš ï¸ " + msg));
          }
        });
    }

    function pointerDepart() {
      fetch('/api/pointage/depart', { method: 'POST' })
        .then(res => {
          if (res.ok) {
            alert("ğŸšª Fin de journÃ©e enregistrÃ©e !");
            loadPointage();
          } else {
            res.text().then(msg => alert("âš ï¸ " + msg));
          }
        });
    }

    function demarrerPause(type) {
      fetch('/api/pauses/debut?type=' + type, { method: 'POST' })
        .then(() => {
          document.getElementById("status").textContent = `DÃ©but de pause "${type}" enregistrÃ©.`;
          loadPauses();
          loadDureePauses();
        });
    }

    function cloturerPause() {
      fetch('/api/pauses/fin', { method: 'POST' })
        .then(() => {
          document.getElementById("status").textContent = "Fin de pause enregistrÃ©e.";
          loadPauses();
          loadDureePauses();
        });
    }

    function loadUserInfo() {
      fetch('/api/users/me')
        .then(res => res.json())
        .then(data => {
          document.getElementById("nom").textContent = data.nom;
          document.getElementById("prenom").textContent = data.prenom;
          document.getElementById("email").textContent = data.email;
          document.getElementById("role").textContent = data.role;
          if (data.role === 'RH' || data.role === 'SUPER_ADMIN') {
            document.getElementById("menu-rh").style.display = 'block';
          }
        });
    }

    function loadPointage() {
      fetch('/api/pointage/aujourdhui')
        .then(res => res.json())
        .then(data => {
          document.getElementById("date").textContent = data.date || "-";
          document.getElementById("arrivee").textContent = data.heureArrivee?.split('.')[0] || "-";
          document.getElementById("depart").textContent = data.heureDepart?.split('.')[0] || "-";

          if (data.heureArrivee) {
            const [h, m, s] = data.heureArrivee.split(":");
            arriveeTime = new Date();
            arriveeTime.setHours(+h, +m, +s);
          }
        });
    }

    function updateDureeDepuisArrivee() {
      if (!arriveeTime) return;
      const now = new Date();
      const diff = Math.floor((now - arriveeTime) / 60000); // en minutes
      const h = Math.floor(diff / 60);
      const m = diff % 60;
      document.getElementById("dureeDepuisArrivee").textContent = `${h}h ${m}min`;
    }

    function loadDureePauses() {
      fetch('/api/pause-stats/duree-aujourdhui')
        .then(res => res.text())
        .then(data => {
          document.getElementById("dureePauses").textContent = `${data} minutes`;
        });
    }

    function loadPauses() {
      fetch('/api/pause-stats/liste')
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById("table-pauses");
          tbody.innerHTML = "";
          data.forEach(p => {
            const duration = p.heureFin
              ? Math.floor((new Date("1970-01-01T" + p.heureFin) - new Date("1970-01-01T" + p.heureDebut)) / 60000)
              : "-";
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${p.type}</td>
              <td>${p.heureDebut ? p.heureDebut.split('.')[0] : '-'}</td>
              <td>${p.heureFin ? p.heureFin.split('.')[0] : '-'}</td>
              <td>${duration}</td>
            `;
            tbody.appendChild(tr);
          });
        });
    }

    function openCongeModal() {
      document.getElementById("congeModal").style.display = "block";
    }

    function closeCongeModal() {
      document.getElementById("congeModal").style.display = "none";
    }

    document.getElementById("form-conge").addEventListener("submit", function (e) {
      e.preventDefault();
      const form = e.target;
      fetch("/api/conges", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          type: form.type.value,
          dateDebut: form.dateDebut.value,
          dateFin: form.dateFin.value,
          commentaire: form.commentaire.value
        })
      })
        .then(res => res.json())
        .then(data => {
          const congeId = data.id;
          const fichier = form.justificatif.files[0];
          if (fichier) {
            const formData = new FormData();
            formData.append("file", fichier);
            return fetch(`/api/conges/${congeId}/justificatif`, {
              method: "POST",
              body: formData
            });
          }
        })
        .then(() => {
          document.getElementById("msg-conge").textContent = "âœ… Demande envoyÃ©e.";
          loadCongesUtilisateur();
          setTimeout(() => {
            closeCongeModal();
            form.reset();
            document.getElementById("msg-conge").textContent = "";
          }, 2000);
        })
        .catch(() => {
          document.getElementById("msg-conge").textContent = "âŒ Erreur.";
        });
    });

    function loadCongesUtilisateur() {
      fetch('/api/conges/mes')
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById("table-conges");
          tbody.innerHTML = "";
          data.forEach(c => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${c.type}</td>
              <td>${c.dateDebut}</td>
              <td>${c.dateFin}</td>
              <td>${c.statut}</td>
              <td>${c.justificatifPath ? `<a href='/${c.justificatifPath}' target='_blank'>ğŸ“ Voir</a>` : '-'}</td>
            `;
            tbody.appendChild(tr);
          });
        });
    }

    function loadSoldeConges() {
      fetch('/api/conges/solde')
        .then(r => r.text())
        .then(d => {
          document.getElementById("soldeConges").textContent = parseFloat(d).toFixed(1);
        });
    }

    // âœ… Initialisation au chargement
    loadUserInfo();
    loadPointage();
    loadDureePauses();
    loadPauses();
    loadCongesUtilisateur();
    loadSoldeConges();

    // âœ… Horloge en direct
    setInterval(() => {
      document.getElementById("heureActuelle").textContent = formatTime(new Date());
      updateDureeDepuisArrivee();
    }, 1000);
</script>
</body>
</html>
