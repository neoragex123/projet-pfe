<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Tableau de bord - GTP</title>
    <style>
        body {
          font-family: 'Segoe UI', sans-serif;
          background: linear-gradient(to bottom right, #e6f0ff, #cce0ff);
          margin: 0;
          padding: 30px;
        }

        .container {
          max-width: 900px;
          margin: auto;
          background: white;
          border-radius: 12px;
          padding: 30px;
          box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        h2 {
          margin-top: 0;
          color: #003865;
        }

        .flex {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .user-info, .status-block, .pause-block, .history-block {
          margin-top: 25px;
          padding: 20px;
          background: #f9f9f9;
          border-radius: 8px;
        }

        .label {
          font-weight: bold;
        }

        button {
          margin: 6px;
          padding: 10px 20px;
          font-size: 14px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          background-color: #007bff;
          color: white;
        }

        button:hover {
          background-color: #0056b3;
        }

        button.stop {
          background-color: #dc3545;
        }

        button.stop:hover {
          background-color: #a71d2a;
        }

        #status {
          margin-top: 10px;
          color: green;
        }

        .logout {
          float: right;
          text-decoration: none;
          font-weight: bold;
          color: #dc3545;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 15px;
        }

        th, td {
          border: 1px solid #ccc;
          padding: 8px 12px;
          text-align: center;
        }

        th {
          background: #003865;
          color: white;
        }
        .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      width: 400px;
      border-radius: 10px;
      position: relative;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    .close {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 22px;
      cursor: pointer;
    }
    </style>
</head>
<body>

<div class="container">
    <div class="flex">
        <h2>Tableau de bord</h2>
        <a class="logout" href="/logout">Se dÃ©connecter</a>
    </div>

    <div class="user-info">
        <p><span class="label">Nom :</span> <span id="nom">-</span></p>
        <p><span class="label">PrÃ©nom :</span> <span id="prenom">-</span></p>
        <p><span class="label">Email :</span> <span id="email">-</span></p>
        <p><span class="label">RÃ´le :</span> <span id="role">-</span></p>
    </div>

    <div class="status-block">
        <p><span class="label">Date aujourdâ€™hui :</span> <span id="date">-</span></p>
        <p><span class="label">Heure dâ€™arrivÃ©e :</span> <span id="arrivee">-</span></p>
        <p><span class="label">Vous Ãªtes arrivÃ© depuis :</span> <span id="dureeDepuisArrivee">-</span></p>
        <p><span class="label">Heure actuelle :</span> <span id="heureActuelle">-</span></p>
    </div>

    <div class="pause-block">
        <h3>DÃ©clarer une pause</h3>
        <button onclick="demarrerPause('CAFÃ‰')">Pause CafÃ©</button>
        <button onclick="demarrerPause('DÃ‰JEUNER')">Pause DÃ©jeuner</button>
        <button onclick="demarrerPause('FORMATION')">Pause Formation</button>
        <button class="stop" onclick="cloturerPause()">Fin de pause</button>
        <p><strong>DurÃ©e totale des pauses :</strong> <span id="dureePauses">-</span></p>
        <div id="status"></div>
    </div>

    <div class="history-block">
        <h3>Pauses du jour</h3>
        <table>
            <thead>
            <tr>
                <th>Type</th>
                <th>Heure dÃ©but</th>
                <th>Heure fin</th>
                <th>DurÃ©e (min)</th>
            </tr>
            </thead>
            <tbody id="table-pauses"></tbody>
        </table>
    </div>
    <div style="text-align: center; margin-top: 30px;">
        <button onclick="openCongeModal()">ðŸ—“ Faire une demande de congÃ©</button>
    </div>
    <div class="history-block">
        <h3>ðŸ“‹ Mes demandes de congÃ©s</h3>
        <table>
            <thead><tr><th>Type</th><th>Date dÃ©but</th><th>Date fin</th><th>Statut</th><th>Justificatif</th></tr></thead>
            <tbody id="table-conges"></tbody>
        </table>
    </div>
</div>

<!-- Modale de demande de congÃ© -->
<div id="congeModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeCongeModal()">&times;</span>
        <h3>Demande de congÃ©</h3>
        <form id="form-conge" enctype="multipart/form-data">
            <label>Type de congÃ© :</label><br>
            <select name="type" required>
                <option value="ANNUEL">Annuel</option>
                <option value="EXCEPTIONNEL">Exceptionnel</option>
                <option value="MALADIE">Maladie</option>
                <option value="DEMI_JOURNEE">Demi-journÃ©e</option>
            </select><br><br>
            <label>Date dÃ©but :</label><br>
            <input type="date" name="dateDebut" required><br><br>
            <label>Date fin :</label><br>
            <input type="date" name="dateFin" required><br><br>
            <label>Commentaire :</label><br>
            <textarea name="commentaire" rows="3" style="width: 100%;"></textarea><br><br>
            <label>Justificatif :</label><br>
            <input type="file" name="justificatif"><br><br>
            <button type="submit">ðŸ“¤ Envoyer</button>
            <p id="msg-conge" style="color: green;"></p>
        </form>
    </div>
</div>
<script>
    let arriveeTime = null;

    function formatTime(date) {
      return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function demarrerPause(type) {
      fetch('/api/pauses/debut?type=' + type, { method: 'POST' })
        .then(() => {
          document.getElementById("status").textContent = `DÃ©but de pause "${type}" enregistrÃ©.`;
          loadPauses();
          loadDureePauses();
        });
    }

    function cloturerPause() {
      fetch('/api/pauses/fin', { method: 'POST' })
        .then(() => {
          document.getElementById("status").textContent = "Fin de pause enregistrÃ©e.";
          loadPauses();
          loadDureePauses();
        });
    }

    function loadUserInfo() {
      fetch('/api/users/me')
        .then(res => res.json())
        .then(data => {
          document.getElementById("nom").textContent = data.nom;
          document.getElementById("prenom").textContent = data.prenom;
          document.getElementById("email").textContent = data.email;
          document.getElementById("role").textContent = data.role;
        });
    }

    function loadPointage() {
      fetch('/api/pointage/aujourdhui')
        .then(res => res.json())
        .then(data => {
          document.getElementById("date").textContent = data.date;
          document.getElementById("arrivee").textContent = data.heureArrivee.split('.')[0];
          arriveeTime = new Date();
          const [h, m, s] = data.heureArrivee.split(":");
          arriveeTime.setHours(+h, +m, +s);
        });
    }

    function updateDureeDepuisArrivee() {
      if (!arriveeTime) return;
      const now = new Date();
      const diff = Math.floor((now - arriveeTime) / 1000 / 60); // minutes
      const h = Math.floor(diff / 60);
      const m = diff % 60;
      document.getElementById("dureeDepuisArrivee").textContent = `${h}h ${m}min`;
    }

    function loadDureePauses() {
      fetch('/api/pause-stats/duree-aujourdhui')
        .then(res => res.text())
        .then(data => {
          document.getElementById("dureePauses").textContent = `${data} minutes`;
        });
    }

    function loadPauses() {
      fetch('/api/pause-stats/liste')
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById("table-pauses");
          tbody.innerHTML = "";
          data.forEach(p => {
            const tr = document.createElement("tr");
            const duration = p.heureFin
              ? Math.floor((new Date("1970-01-01T" + p.heureFin) - new Date("1970-01-01T" + p.heureDebut)) / 60000)
              : "-";
            tr.innerHTML = `
              <td>${p.type}</td>
              <td>${p.heureDebut ? p.heureDebut.split('.')[0] : '-'}</td>
              <td>${p.heureFin ? p.heureFin.split('.')[0] : '-'}</td>
              <td>${duration}</td>
            `;
            tbody.appendChild(tr);
          });
        });
    }
    function openCongeModal() {
  document.getElementById("congeModal").style.display = "block";
}
function closeCongeModal() {
  document.getElementById("congeModal").style.display = "none";
}

document.getElementById("form-conge").addEventListener("submit", function (e) {
  e.preventDefault();

  const form = e.target;

  // Ã‰tape 1 : crÃ©er le congÃ©
  fetch("/api/conges", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      type: form.type.value,
      dateDebut: form.dateDebut.value,
      dateFin: form.dateFin.value,
      commentaire: form.commentaire.value
    })
  })
    .then(res => res.json())
    .then(data => {
      const congeId = data.id;
      const fichier = form.justificatif.files[0];
      if (fichier) {
        const fileData = new FormData();
        fileData.append("file", fichier);
        return fetch(`/api/conges/${congeId}/justificatif`, {
          method: "POST",
          body: fileData
        });
      }
    })
    .then(() => {
      document.getElementById("msg-conge").textContent = "âœ… Demande envoyÃ©e.";
      loadCongesUtilisateur();
      setTimeout(() => {
        closeCongeModal();
        form.reset();
        document.getElementById("msg-conge").textContent = "";
      }, 2000);
    })
    .catch(() => {
      document.getElementById("msg-conge").textContent = "âŒ Erreur.";
    });
});

function loadCongesUtilisateur() {
  fetch('/api/conges/mes')
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById("table-conges");
      tbody.innerHTML = "";
      data.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.type}</td>
          <td>${c.dateDebut}</td>
          <td>${c.dateFin}</td>
          <td>${c.statut}</td>
          <td>${c.justificatifPath
              ? `<a href='/${c.justificatifPath}' target='_blank'>ðŸ“Ž Voir</a>` : '-'}</td>
        `;
        tbody.appendChild(tr);
      });
    });
}

// âš ï¸ Appelle la fonction au chargement
loadCongesUtilisateur();

    // âœ… Horloge en direct
    setInterval(() => {
      document.getElementById("heureActuelle").textContent = formatTime(new Date());
      updateDureeDepuisArrivee();
    }, 1000);

    loadUserInfo();
    loadPointage();
    loadDureePauses();
    loadPauses();
</script>

</body>
</html>
